# This workflow will run tests using node and then publish a package to GitHub Packages when a release is created
# For more information see: https://docs.github.com/en/actions/publishing-packages/publishing-nodejs-packages

name: Technotic Publish Action

on: 
  workflow_dispatch:
    inputs:
      branch:
        description: 'Define branch name'     
        required: true
        default: 'production'
      version-type:
        description: 'Define version type!, [major | minor | patch]'
        required: true
        default: 'minor'

jobs:
    release:
        runs-on: ubuntu-latest
        steps:
            - uses: actions/checkout@v3
              with:
                  ref: ${{ github.event.inputs.branch }}
            - uses: actions/setup-node@v3
              with:
                  node-version: 14
            - uses: 'phips28/gh-action-bump-version@master'
              env:
                  GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
              with:
                  version-type:  ${{ github.event.inputs.version-type }}
            - run: npm ci

    publish-npm:
        needs: release
        runs-on: ubuntu-latest
        steps:
            - uses: actions/checkout@v3
              with:
                  ref: ${{ github.event.inputs.branch }}
            - uses: actions/setup-node@v3
              with:
                  node-version: 14
                  registry-url: https://registry.npmjs.org/
            - run: npm ci
            - run: npm publish --access public
              env:
                  NODE_AUTH_TOKEN: ${{secrets.NPM_TOKEN}}
    create-pr:
        needs: publish-npm
        runs-on: ubuntu-latest
        steps:
            - name: Set current date as env variable
              run: echo "NOW=$(date +'%Y-%m-%dT%H:%M:%S')" >> $GITHUB_ENV
            - uses: peter-evans/create-pull-request@v4
              with: 
                  token: ${{ secrets.GITHUB_TOKEN }}
                  committer: Satpam RnD <noreply@bncc.net>
                  author: ${{ github.actor }} <${{ github.actor }}@users.noreply.github.com>
                  title: "chore: production sync on ${{ env.NOW }}"
                  body: |
                    Auto Version Sync After Publish
                    - Updated with *today's* date
                    - This PR is Auto-generated.
                  labels: |
                    automated pr
                  
